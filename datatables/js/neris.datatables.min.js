/**
 * 数据表格组件，使用前请阅读组件API文档。
 * 旧的分页表格组件（neris.grid.js）新功能已停止更新，使用上下分页等新功能请使用此组件。
 * 该组件依赖第三方插件 jQuery、jquery.dataTables.js、dataTables.bootstrap.js。
 *
 * Copyright ® 中国证监会中央监管信息平台版权所有
 *
 * Author: 公共组件组Gongph
 * Version: 2.3.1
 * Date: 2017/10/11
 */
if(typeof jQuery==='undefined'){throw new Error('NerisDatatable\'s JavaScript requires jQuery')}+(function($){'use strict';var settings={},roots={},_consts={SIGN:'#',SEQSTR:'序号',id:{DIV:'_wrapper',PAGE_INFO:'.neris-page-info',ALL_CHECKED:'.dataTables_allcheck',CHECKED:'.dataTables_check',BTN_JUMP:'.btn-jump'},event:{ALL_CHECKED:'dataTables_allcheck',EMIT_ALL_STATE:'emit_dataTables_allcheck_state',CHECKED:'dataTables_check',JUMPTO:'btn-jump',INIT_COMPLETE:'init_complete',DRAW_COMPLETE:'draw_complete'}},consts=_consts,_setting={tableId:'',tableObj:null,dt:null,indexing:false,checking:false,processing:false,serverSide:true,paging:true,pageLength:5,pageShow:'bottom',scrollX:false,ordering:false,rowId:'',ajax:null,dom:'',rowData:null,columns:[],language:{info:'当前第 _PAGE_ 页 / 共 _PAGES_ 页',infoEmpty:'当前第 0 页 / 共 0 页',lengthMenu:'每页显示  _MENU_ 条',search:'查询: ',paginate:{first:'首页',last:'末页',next:'下一页',previous:'上一页'},processing:'加载中...',loadingRecords:'加载中...',zeroRecords:'没有符合条件的数据！'},callback:{initComplete:null,drawComplete:null,onAllChecked:null,onChecked:null}},_initRoot=function(setting){var r=data.getRoot(setting);if(!r){r={};data.setRoot(setting,r)}r.curSelectedList={};r.container=setting.tableId+consts.id.DIV;r.dt=setting.dt;r._ver=(new Date()).getTime()},_bindEvent=function(setting){var root=data.getRoot(setting),c=consts.event,o=$(consts.SIGN+root.container);o.bind(c.EMIT_ALL_STATE,function(){var curPageSelectedList=data.getCurPageSelectedList(setting),curPageRowData=data.getCurPageRowsData(setting);if(curPageSelectedList.length==curPageRowData.length&&curPageRowData.length>0){view.setAllChecked(setting)}else{view.cancelAllChecked(setting)}});o.bind(c.ALL_CHECKED,function(event,srcEvent,rowsData){tools.apply(setting.callback.onAllChecked,[srcEvent,rowsData])});o.bind(c.CHECKED,function(event,srcEvent,rowData){tools.apply(setting.callback.onChecked,[srcEvent,rowData])});o.bind(c.INIT_COMPLETE,function(){tools.apply(setting.callback.initComplete)});o.bind(c.DRAW_COMPLETE,function(){tools.apply(setting.callback.drawComplete)})},_unbindEvent=function(setting){var root=data.getRoot(setting),c=consts.event,o=$(consts.SIGN+root.container);o.unbind(c.EMIT_ALL_STATE).unbind(c.ALL_CHECKED).unbind(c.CHECKED).unbind(c.INIT_COMPLETE).unbind(c.DRAW_COMPLETE)},_init={bind:[_bindEvent],unbind:[_unbindEvent],roots:[_initRoot]},data={addCheckedData:function(setting,event){var target=event.target,rowId=$(target).closest('tr').prop('id'),hasChecked=data.isCheckedCurrentRow(setting,rowId),ischecked=$(target).prop('checked'),root=data.getRoot(setting),rowsData=data.getCurPageSelectedList(setting),rowData=data.getCurPageRowData(setting,rowId);if(ischecked){if(!hasChecked){rowsData.push(rowData)}}else{if(hasChecked){var index=data.getIndexFromSelectedList(setting,rowId);if(index>-1){rowsData.splice(index,1)}}}$(consts.SIGN+root.container).trigger(consts.event.EMIT_ALL_STATE);$(consts.SIGN+root.container).trigger(consts.event.CHECKED,[event,rowData])},addAllcheckedData:function(setting,event,checkFlag){var curPage=data.getCurPage(setting),rowsData=data.getCurPageRowsData(setting),root=data.getRoot(setting);if(checkFlag){view.selectedRows(setting);root.curSelectedList[curPage]=rowsData;}else{view.cancelCheckeds(setting);delete root.curSelectedList[curPage];}$(consts.SIGN+root.container).trigger(consts.event.ALL_CHECKED,[event,rowsData])},addRowData:function(setting){if(!setting.rowData||!tools.isObject(setting.rowData)){return}var ed=setting.rowData,curPage=data.getCurPage(setting),curSelectedList=data.getCurSelectedList(setting);for(var p in ed){var rids=ed[p];for(var i=0,len=rids.length;i<len;i+=1){var rowId=rids[i][setting.rowId];if(!curSelectedList[p]){curSelectedList[p]=[]}curSelectedList[p].push(rids[i]);if(p==curPage){var rowNode=view.findRowByRowId(setting,rowId);if(rowNode){view.selectedRow(setting,rowNode)}}}}},checkAllCheckedState:function(setting){var allcheckedState=false,curPageSelectedList=data.getCurPageSelectedList(setting),curPageRowData=data.getCurPageRowsData(setting);if(curPageSelectedList.length==curPageRowData.length&&curPageRowData.length>0){allcheckedState=true}return allcheckedState},clearCurSelectedList:function(setting){data.getRoot(setting).curSelectedList={}},isCheckedCurrentRow:function(setting,rowId){var curPage=data.getCurPage(setting),curPageSelectedList=data.getCurPageSelectedList(setting),ischecked=false;if(curPageSelectedList.length>0){for(var i=0,len=curPageSelectedList.length;i<len;i+=1){if(curPageSelectedList[i][setting.rowId]===rowId){ischecked=true;break}}}return ischecked},initTable:function(setting){if(setting==null){errors.noArgumentsSpecifiedException()}if(setting.checking&&!setting.rowId){errors.noRowIdSpecifiedException()}var flag=0;if(setting.indexing){setting.columns.unshift(view.addSequenceColumn());flag+=1}if(setting.checking){setting.columns.unshift(view.addCheckingColumn());flag+=1}if(setting.scrollX){$(consts.SIGN+setting.tableId).addClass('nowrap')}if(setting.processing){$(consts.SIGN+setting.tableId).addClass('datatables-loading')}$.fn.dataTable.ext.errMode='none';var table=setting.tableObj.DataTable({language:setting.language,serverSide:setting.serverSide,rowId:setting.rowId,paging:setting.paging,pageLength:setting.pageLength,scrollX:setting.scrollX,ordering:setting.ordering,ajax:setting.ajax,dom:setting.dom?setting.dom:view.addDom(setting),columns:setting.columns,initComplete:function(settings,json){var root=data.getRoot(setting),tableWapper=consts.SIGN+root.container;data.initCustomScrollbar(setting);data.addRowData(setting);$(tableWapper).trigger(consts.event.INIT_COMPLETE)},preDrawCallback:function(){view.setTbodyStyles(this,setting,{'opacity':0.8});var tbody=this.api().table().body();if(tbody.children.length<=0){var tr="<tr><td colspan='"+(setting.columns.length+flag)+"' style='height: 200px'></td></tr>";$(tbody).append(tr)}},drawCallback:function(settings){var root=data.getRoot(setting),tableWapper=consts.SIGN+root.container,total=settings.json.recordsTotal||0;$(this.api().table().body()).removeAttr('style');var html=view.addPageInfoDom(this.api().page.info());view.insertPageInfoNodes(setting,html);if(total<=0){view.disabledJumpBtnDom(tableWapper,true);}view.handleAllCheckedState(setting);$(tableWapper).trigger(consts.event.DRAW_COMPLETE)},rowCallback:function(row,data){view.selectedRow(setting,row)}});return table},initCustomScrollbar:function(setting){if(!setting.scrollX){return}var root=data.getRoot(setting),c=consts.SIGN+root.container;$(c).find('.dataTables_scroll').mCustomScrollbar({theme:'minimal-dark',horizontalScroll:true,advanced:{updateOnSelectorChange:true},callbacks:{onScroll:function(){$(c).find(".mCustomScrollBox").removeAttr("style")}}});$(c).find(".dataTables_scrollBody").removeAttr("style");$(c).find(".mCSB_horizontal.mCSB_inside .mCSB_container").css({marginBottom:"10px"})},initRoot:function(setting){for(var i=0,len=_init.roots.length;i<len;i+=1){_init.roots[i].apply(this,arguments)}},getRoot:function(setting){return setting?roots[setting.tableId]:null},getSetting:function(tableId){return settings[tableId]},getSettings:function(){return settings},getDT:function(setting){return data.getRoot(setting).dt},getCurPage:function(setting){return data.getDT(setting).page()+1},getPages:function(setting){return data.getDT(setting).page.info().pages},getCurPageRowsNodes:function(setting){return dt.rows({page:'current'}).nodes()},getCurPageRowData:function(setting,rowId){var curRows=data.getDT(setting).rows({page:'current'});;return curRows.row(consts.SIGN+rowId).data()},getCurPageRowsData:function(setting){var rowData=[],curRows=data.getDT(setting).rows({page:'current'});data.getDT(setting).rows({page:'current'}).nodes().each(function(row,index){var checkboxOfRow=$(row).find(consts.id.CHECKED);if(!checkboxOfRow.prop('disabled')){var data=curRows.row(index).data();rowData.push(data)}});return rowData},getCurSelectedList:function(setting){return data.getRoot(setting).curSelectedList},getCurPageSelectedList:function(setting,page){var curSelectedList=data.getRoot(setting).curSelectedList,curPage=page||data.getCurPage(setting);if(!curSelectedList[curPage]){curSelectedList[curPage]=[]}return curSelectedList[curPage]},getIndexFromSelectedList:function(setting,rowId){var curPage=data.getCurPage(setting),curPageSelectedList=data.getCurPageSelectedList(setting),index=-1;for(var i=0,len=curPageSelectedList.length;i<len;i+=1){if(curPageSelectedList[i][setting.rowId]===rowId){index=i;break}}return index},setRoot:function(setting,root){roots[setting.tableId]=root}},event={bindEvent:function(setting){for(var i=0,len=_init.bind.length;i<len;i+=1){_init.bind[i].apply(this,arguments)}},unbindEvent:function(setting){for(var i=0,len=_init.unbind.length;i<len;i+=1){_init.unbind[i].apply(this,arguments)}},bindTable:function(setting){var root=data.getRoot(setting);$(consts.SIGN+root.container).bind('click',function(event){var target=event.target;if(tools.eqs(target.tagName,'input')&&target.getAttribute('class')!==null){if(tools.eqs(target.getAttribute('class'),consts.event.ALL_CHECKED)){data.addAllcheckedData(setting,event,$(target).prop('checked'))}else if(tools.eqs(target.getAttribute('class'),consts.event.CHECKED)){data.addCheckedData(setting,event)}}else if(tools.eqs(target.tagName,'button')&&$(target).hasClass(consts.event.JUMPTO)){var ip=$(target).siblings(),num=parseInt(ip.val().trim());if(isNaN(num)||!/^[1-9]\d*$/.test(num)||num>data.getPages(setting)){ip.focus().val('');alert('请输入有效的页码！');return}data.getDT(setting).page(num-1).draw(false)}})},unbindTable:function(setting){var root=data.getRoot(setting);$(consts.SIGN+root.container).unbind('click')}},errors={noArgumentsSpecifiedException:function(){throw new Error('No arguments are specified Exception!')},noRowIdSpecifiedException:function(){throw new Error('No `rowId` are specified exception!')}},tools={apply:function(fun,param){if((typeof fun)=='function'){return fun.apply(nd,param?param:[])}},clone:function clone(obj){if(obj==null){return null}var o=tools.isArray(obj)?[]:{};for(var i in obj){o[i]=(obj[i]instanceof Date)?new Date(obj[i].getTime()):(typeof obj[i]==='object'?clone(obj[i]):obj[i])}return o},eqs:function(str1,str2){return str1.toLowerCase()===str2.toLowerCase()},isArray:function(arr){return Object.prototype.toString.apply(arr)==='[object Array]'},isObject:function(obj){return Object.prototype.toString.apply(obj)==='[object Object]'}},view={addSequenceColumn:function(){var seq={data:null,title:consts.SEQSTR,render:function(data,type,row,meta){return meta.row+1}};return seq},addCheckingColumn:function(){var checking={data:null,title:view.addAllCheckNode(),orderable:false,defaultContent:view.addCheckNode()};return checking},addAllCheckNode:function(){return '<input type="checkbox" class="dataTables_allcheck"/>'},addCheckNode:function(){return '<input type="checkbox" class="dataTables_check"/>'},addDom:function(setting){if(!setting.paging){return 't'}var dom='<"row"<"col-sm-7"p><"neris-page-info col-sm-5"i>>',show='';if(setting.pageShow=='top'){show=dom+'rt'}else if(setting.pageShow=='bottom'){show='rt'+dom}else{show=dom+'rt'+dom}return show},addPageInfoDom:function(pageInfo){var html=[];view.makeDOMNodePageInfo(html,pageInfo);view.makeDOMNodeJumpBtn(html,pageInfo);return html},cancelAllChecked:function(setting){var root=data.getRoot(setting);$(consts.SIGN+root.container).find(consts.id.ALL_CHECKED).prop('checked',false)},cancelChecked:function(node){$(node).prop('checked',false)},cancelCheckeds:function(setting){view.findCheckboxOfRows(setting).prop('checked',false)},disabledJumpBtnDom:function(root,state){$(root).find(consts.id.PAGE_INFO+' '+consts.id.BTN_JUMP).prop('disabled',state)},findCheckboxOfRow:function(rowNode){return $(rowNode).find(consts.id.CHECKED)},findCheckboxOfRows:function(setting){return $(data.getDT(setting).table().body()).find('input[type="checkbox"]:not(:disabled)')},findRowByRowId:function(setting,rowId){return data.getDT(setting).rows({page:'current'}).row(consts.SIGN+rowId).node()},handleAllCheckedState:function(setting){var flag=data.checkAllCheckedState(setting);flag?view.setAllChecked(setting):view.cancelAllChecked(setting)},insertPageInfoNodes:function(setting,node){var root=data.getRoot(setting);$(consts.SIGN+root.container).find(consts.id.PAGE_INFO).html(node.join(''))},makeDOMNodePageInfo:function(html,pageInfo){html.push('<div class="dataTables_info">共 ',pageInfo.pages,' 页，',pageInfo.recordsTotal,' 条记录。')},makeDOMNodeJumpBtn:function(html){html.push('跳转到第 <input type="text" class="jump-page"/> 页 ','<button type="button" class="btn btn-xs btn-primary btn-jump">GO</button></div>')},setAllChecked:function(setting){var root=data.getRoot(setting);$(consts.SIGN+root.container).find(consts.id.ALL_CHECKED).prop('checked',true)},setChecked:function(node,state){$(node).prop('checked',state)},selectedRows:function(setting){view.findCheckboxOfRows(setting).prop('checked',true)},selectedRow:function(setting,rowNode){var rowId=$(rowNode).prop('id'),checkboxOfRow=view.findCheckboxOfRow(rowNode);if(data.isCheckedCurrentRow(setting,rowId)){view.setChecked(checkboxOfRow,true)}},setTbodyStyles:function(dt,setting,styleObject){if(setting.processing){$(dt.api().table().body()).css(styleObject)}}};$.fn.nerisDataTables=function(nSetting){var setting=tools.clone(_setting);$.extend(true,setting,nSetting);setting.tableId=$(this).prop('id');setting.tableObj=$(this);setting.dt=data.initTable(setting);settings[setting.tableId]=setting;data.initRoot(setting);event.unbindTable(setting);event.bindTable(setting);event.unbindEvent(setting);event.bindEvent(setting);var dt=data.getDT(setting),ndtools={setting:setting,draw:function(paging){dt.draw(paging==undefined?true:paging);data.clearCurSelectedList(setting)},destroy:function(){dt.destroy(true)},getSelectedRowData:function(){var cloneData=tools.clone(data.getCurSelectedList(setting)),attrs=[];for(var p in cloneData){if(cloneData.hasOwnProperty(p)){var rowData=cloneData[p];for(var i=0,len=rowData.length;i<len;i+=1){attrs.push(tools.clone(rowData[i]))}}}return attrs},getSelectedPageData:function(){return tools.clone(data.getCurSelectedList(setting))},setChecked:function(rowId,flag){var rowsData=data.getCurPageSelectedList(setting),rowData=data.getCurPageRowData(setting,rowId),index=data.getIndexFromSelectedList(setting,rowId);if(!rowData){return}if(index==-1&&flag){rowsData.push(rowData)}if(index>-1&&!flag){rowsData.splice(index,1)}var rowNode=view.findRowByRowId(setting,rowId),checkboxOfRow=view.findCheckboxOfRow(rowNode);view.setChecked(checkboxOfRow,flag)},setPage:function(page,flag){flag=flag||false;if(!page||parseInt(page,10)<0){page=1}if(typeof page==='string'&&/^[first|last|next|previous]+$/.test(page)){dt.page(page).draw(flag)}else if(typeof page==='number'){var maxpage=data.getPages(setting);if(maxpage<=page){page=maxpage}dt.page(page-1).draw(flag)}}};return ndtools};var nd=$.fn.nerisDataTables})(jQuery);